<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyse des Bases de Donn√©es</title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        h1 { color: #569cd6; }
        h2 { color: #4ec9b0; margin-top: 30px; }
        h3 { color: #ce9178; }
        .database {
            background: #252526;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #007acc;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
        .info { color: #569cd6; }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border: 1px solid #3c3c3c;
            overflow-x: auto;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #005a9e;
        }
        #output {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>üîç Analyse des Bases de Donn√©es TBM</h1>
    <p>Cet outil compare les diff√©rentes versions de bases de donn√©es pour identifier les diff√©rences.</p>

    <button onclick="analyzeDatabases()">üöÄ Analyser toutes les bases</button>
    <button onclick="generateSchema()">üì• G√©n√©rer schema.json</button>
    <button onclick="clearOutput()">üóëÔ∏è Effacer</button>

    <div id="output"></div>

    <script>
        const API_BASE_URL = 'https://wr-daher.lumiscaphe.com';

        async function fetchDatabases() {
            const url = `${API_BASE_URL}/Databases`;
            console.log('üîç Fetching databases from:', url);

            const response = await fetch(url);
            console.log('   Response status:', response.status);

            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const xmlText = await response.text();
            console.log('   XML received (first 200 chars):', xmlText.substring(0, 200));

            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

            // V√©rifier erreur de parsing
            const parserError = xmlDoc.querySelector('parsererror');
            if (parserError) {
                console.error('‚ùå Erreur parsing XML:', parserError.textContent);
                throw new Error('Erreur parsing XML: ' + parserError.textContent);
            }

            console.log('   Root element:', xmlDoc.documentElement.tagName);

            const databases = [];

            // Essayer avec 'Database' (majuscule)
            let dbElements = xmlDoc.querySelectorAll('Database');
            console.log(`   Database (majuscule) trouv√©s: ${dbElements.length}`);

            // Si rien, essayer 'database' (minuscule)
            if (dbElements.length === 0) {
                dbElements = xmlDoc.querySelectorAll('database');
                console.log(`   database (minuscule) trouv√©s: ${dbElements.length}`);
            }

            dbElements.forEach(db => {
                const name = db.getAttribute('name');
                const id = db.getAttribute('id');
                console.log(`   DB found: name="${name}", id="${id}"`);
                if (name && id) {
                    databases.push({ name, id });
                }
            });

            console.log('‚úÖ Databases:', databases);
            return databases;
        }

        async function fetchDatabaseXML(databaseId) {
            const url = `${API_BASE_URL}/Database?databaseId=${databaseId}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            const xmlText = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');

            // V√©rifier erreur de parsing
            const parserError = xmlDoc.querySelector('parsererror');
            if (parserError) {
                throw new Error('Erreur parsing XML: ' + parserError.textContent);
            }

            return xmlDoc;
        }

        function extractParameters(xmlDoc) {
            const parameters = {
                configurationBookmarks: [],
                cameraGroups: [],
                cameraGroupsDetails: [], // NOUVEAU: avec d√©tails
                parameters: [],
                parametersDetails: [], // NOUVEAU: avec options et values
                prestigeOptions: []
            };

            console.log('üìä Extraction des param√®tres du XML...');
            console.log('   Root element:', xmlDoc.documentElement.tagName);

            // Extraire les ConfigurationBookmark
            const bookmarks = xmlDoc.querySelectorAll('ConfigurationBookmark');
            console.log(`   ConfigurationBookmark trouv√©s: ${bookmarks.length}`);
            bookmarks.forEach(bookmark => {
                const label = bookmark.getAttribute('label');
                if (label) {
                    parameters.configurationBookmarks.push(label);
                }
            });

            // Extraire les groupes de cam√©ras (Group)
            const groups = xmlDoc.querySelectorAll('Group');
            console.log(`   Group trouv√©s: ${groups.length}`);
            groups.forEach(group => {
                const name = group.getAttribute('name');
                const id = group.getAttribute('id');
                if (name) {
                    parameters.cameraGroups.push(name);
                    parameters.cameraGroupsDetails.push({ name, id });
                }
            });

            // Extraire les Parameter (dropdowns) AVEC leurs options
            const params = xmlDoc.querySelectorAll('Parameter');
            console.log(`   Parameter trouv√©s: ${params.length}`);
            params.forEach(param => {
                const label = param.getAttribute('label');
                if (label) {
                    parameters.parameters.push(label);

                    // Extraire les options de ce param√®tre
                    const options = [];
                    const valueElements = param.querySelectorAll('Value');
                    valueElements.forEach(val => {
                        const optLabel = val.getAttribute('label');
                        const optSymbol = val.getAttribute('symbol');
                        if (optLabel && optSymbol) {
                            options.push({ label: optLabel, symbol: optSymbol });
                        }
                    });

                    parameters.parametersDetails.push({
                        label: label,
                        options: options
                    });
                }
            });

            // Extraire les prestiges (ConfigurationBookmark avec label "Interior_PrestigeSelection_*")
            const prestiges = xmlDoc.querySelectorAll('ConfigurationBookmark[label^="Interior_PrestigeSelection_"]');
            console.log(`   Prestiges trouv√©s: ${prestiges.length}`);
            prestiges.forEach(bookmark => {
                const label = bookmark.getAttribute('label');
                if (label) {
                    const prestigeName = label.replace('Interior_PrestigeSelection_', '');
                    parameters.prestigeOptions.push(prestigeName);
                }
            });

            console.log('‚úÖ Extraction termin√©e:', parameters);
            return parameters;
        }

        function compareDatabases(databases, allParams) {
            const output = document.getElementById('output');
            output.innerHTML = '<h2>üìä Comparaison des Bases</h2>';

            // Afficher d'abord TOUS les parameters de CHAQUE base AVEC leurs options
            output.innerHTML += '<h2>üìã Liste d√©taill√©e des Parameters par base</h2>';

            databases.forEach((db, index) => {
                const params = allParams[index];
                output.innerHTML += `
                    <div class="database">
                        <h3 class="info">${db.name}</h3>
                        <p><strong>Parameters (${params.parameters.length}):</strong></p>
                `;

                // Afficher chaque param√®tre avec ses options
                params.parametersDetails.forEach(param => {
                    output.innerHTML += `
                        <div style="margin: 10px 0; padding: 10px; background: #1e1e1e; border-left: 3px solid #007acc;">
                            <strong style="color: #4ec9b0;">${param.label}</strong>
                            ${param.options.length > 0 ? `
                                <div style="margin-left: 15px; margin-top: 5px;">
                                    ${param.options.map(opt => `
                                        <div style="margin: 3px 0;">
                                            <span style="color: #dcdcaa;">${opt.label}</span>
                                            <span style="color: #569cd6;"> ‚Üí </span>
                                            <span style="color: #ce9178;">${opt.symbol}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<div style="margin-left: 15px; color: #f48771;">Aucune option trouv√©e</div>'}
                        </div>
                    `;
                });

                output.innerHTML += `</div>`;
            });

            // Cr√©er un tableau de comparaison
            const allBookmarks = new Set();
            const allCameraGroups = new Set();
            const allParameters = new Set();
            const allPrestiges = new Set();

            databases.forEach((db, index) => {
                allParams[index].configurationBookmarks.forEach(c => allBookmarks.add(c));
                allParams[index].cameraGroups.forEach(c => allCameraGroups.add(c));
                allParams[index].parameters.forEach(c => allParameters.add(c));
                allParams[index].prestigeOptions.forEach(c => allPrestiges.add(c));
            });

            // Afficher les statistiques
            output.innerHTML += `
                <div class="database">
                    <h3>üìà Statistiques Globales</h3>
                    <p><span class="info">ConfigurationBookmarks uniques:</span> ${allBookmarks.size}</p>
                    <p><span class="info">Groupes de cam√©ras uniques:</span> ${allCameraGroups.size}</p>
                    <p><span class="info">Parameters uniques:</span> ${allParameters.size}</p>
                    <p><span class="info">Prestiges uniques:</span> ${allPrestiges.size}</p>
                </div>
            `;

            // Comparer chaque base avec la r√©f√©rence (derni√®re)
            const referenceIndex = databases.length - 1;
            const reference = allParams[referenceIndex];

            databases.forEach((db, index) => {
                if (index === referenceIndex) {
                    output.innerHTML += `
                        <div class="database">
                            <h3 class="success">‚úÖ ${db.name} (R√âF√âRENCE)</h3>
                            <p><span class="info">ID:</span> ${db.id}</p>
                            <p><span class="info">ConfigurationBookmarks:</span> ${allParams[index].configurationBookmarks.length}</p>
                            <p><span class="info">Groupes cam√©ras:</span> ${allParams[index].cameraGroups.length}</p>
                            <p><span class="info">Parameters:</span> ${allParams[index].parameters.length}</p>
                            <p><span class="info">Prestiges:</span> ${allParams[index].prestigeOptions.length}</p>
                        </div>
                    `;
                } else {
                    const params = allParams[index];

                    // Calculer les diff√©rences
                    const missingBookmarks = reference.configurationBookmarks.filter(c => !params.configurationBookmarks.includes(c));
                    const missingCameraGroups = reference.cameraGroups.filter(c => !params.cameraGroups.includes(c));
                    const missingParameters = reference.parameters.filter(c => !params.parameters.includes(c));
                    const missingPrestiges = reference.prestigeOptions.filter(c => !params.prestigeOptions.includes(c));

                    const extraBookmarks = params.configurationBookmarks.filter(c => !reference.configurationBookmarks.includes(c));
                    const extraCameraGroups = params.cameraGroups.filter(c => !reference.cameraGroups.includes(c));
                    const extraParameters = params.parameters.filter(c => !reference.parameters.includes(c));
                    const extraPrestiges = params.prestigeOptions.filter(c => !reference.prestigeOptions.includes(c));

                    output.innerHTML += `
                        <div class="database">
                            <h3 class="warning">‚ö†Ô∏è ${db.name}</h3>
                            <p><span class="info">ID:</span> ${db.id}</p>

                            <h4>üìã ConfigurationBookmarks manquants (vs r√©f√©rence):</h4>
                            ${missingBookmarks.length > 0 ? `<pre>${missingBookmarks.slice(0, 30).join('\n')}${missingBookmarks.length > 30 ? '\n... (' + (missingBookmarks.length - 30) + ' autres)' : ''}</pre>` : '<p class="success">Aucun</p>'}

                            <h4>üìã ConfigurationBookmarks suppl√©mentaires:</h4>
                            ${extraBookmarks.length > 0 ? `<pre>${extraBookmarks.slice(0, 30).join('\n')}${extraBookmarks.length > 30 ? '\n... (' + (extraBookmarks.length - 30) + ' autres)' : ''}</pre>` : '<p class="success">Aucun</p>'}

                            <h4>üì∑ Groupes cam√©ras manquants:</h4>
                            ${missingCameraGroups.length > 0 ? `<pre>${missingCameraGroups.join('\n')}</pre>` : '<p class="success">Aucun</p>'}

                            <h4>üì∑ Groupes cam√©ras suppl√©mentaires:</h4>
                            ${extraCameraGroups.length > 0 ? `<pre>${extraCameraGroups.join('\n')}</pre>` : '<p class="success">Aucun</p>'}

                            <h4>‚öôÔ∏è Parameters manquants:</h4>
                            ${missingParameters.length > 0 ? `<pre>${missingParameters.join('\n')}</pre>` : '<p class="success">Aucun</p>'}

                            <h4>‚öôÔ∏è Parameters suppl√©mentaires:</h4>
                            ${extraParameters.length > 0 ? `<pre>${extraParameters.join('\n')}</pre>` : '<p class="success">Aucun</p>'}

                            <h4>üé® Prestiges manquants:</h4>
                            ${missingPrestiges.length > 0 ? `<pre>${missingPrestiges.join('\n')}</pre>` : '<p class="success">Aucun</p>'}

                            <h4>üé® Prestiges suppl√©mentaires:</h4>
                            ${extraPrestiges.length > 0 ? `<pre>${extraPrestiges.join('\n')}</pre>` : '<p class="success">Aucun</p>'}
                        </div>
                    `;
                }
            });
        }

        window.analyzeDatabases = async function() {
            console.clear();
            console.log('üöÄ DEBUT ANALYSE DES BASES');

            const output = document.getElementById('output');
            output.innerHTML = '<h2 class="info">‚è≥ Analyse en cours...</h2>';

            try {
                // 1. R√©cup√©rer la liste des bases
                console.log('ETAPE 1: R√©cup√©ration liste des bases');
                output.innerHTML += '<p>üìã R√©cup√©ration de la liste des bases...</p>';
                const databases = await fetchDatabases();
                console.log('ETAPE 1 TERMINEE:', databases);
                output.innerHTML += `<p class="success">‚úÖ ${databases.length} base(s) trouv√©e(s):</p><pre>${databases.map(db => `- ${db.name} (${db.id})`).join('\n')}</pre>`;

                // 2. T√©l√©charger le XML de chaque base
                const allParams = [];
                for (let i = 0; i < databases.length; i++) {
                    const db = databases[i];
                    output.innerHTML += `<p>üì• T√©l√©chargement XML de "${db.name}"...</p>`;
                    const xmlDoc = await fetchDatabaseXML(db.id);
                    const params = extractParameters(xmlDoc);
                    allParams.push(params);
                    output.innerHTML += `<p class="success">‚úÖ ${db.name}: ${params.configurationBookmarks.length} bookmarks, ${params.cameraGroups.length} camera groups, ${params.parameters.length} parameters, ${params.prestigeOptions.length} prestiges</p>`;
                }

                // 3. Comparer les bases
                output.innerHTML += '<p class="info">üîç Comparaison des bases...</p>';
                compareDatabases(databases, allParams);

                output.innerHTML += '<h2 class="success">‚úÖ Analyse termin√©e !</h2>';

            } catch (error) {
                output.innerHTML += `<p class="error">‚ùå Erreur: ${error.message}</p>`;
                console.error(error);
            }
        };

        window.clearOutput = function() {
            document.getElementById('output').innerHTML = '';
        };

        /**
         * G√©n√®re le sch√©ma JSON complet et le t√©l√©charge
         */
        window.generateSchema = async function() {
            console.clear();
            console.log('üöÄ GENERATION DU SCHEMA JSON');

            const output = document.getElementById('output');
            output.innerHTML = '<h2 class="info">‚è≥ G√©n√©ration du sch√©ma en cours...</h2>';

            try {
                // 1. R√©cup√©rer la liste des bases
                output.innerHTML += '<p>üìã R√©cup√©ration de la liste des bases...</p>';
                const databases = await fetchDatabases();

                // 2. Construire le sch√©ma complet
                const schema = {
                    generatedAt: new Date().toISOString(),
                    databaseVersions: []
                };

                for (let i = 0; i < databases.length; i++) {
                    const db = databases[i];
                    output.innerHTML += `<p>üì• Analyse de "${db.name}"...</p>`;

                    const xmlDoc = await fetchDatabaseXML(db.id);
                    const params = extractParameters(xmlDoc);

                    // Analyser les camera groups
                    const cameraGroups = analyzeCameraGroups(params.cameraGroupsDetails);

                    // Analyser les features disponibles
                    const features = analyzeFeatures(params, cameraGroups);

                    // Construire l'objet version
                    const versionData = {
                        id: db.id,
                        name: db.name,
                        version: `V${i + 1}`,
                        features: features,
                        cameraGroups: cameraGroups,
                        parameters: buildParametersSchema(params.parametersDetails),
                        configurationBookmarks: params.configurationBookmarks,
                        prestigeOptions: params.prestigeOptions
                    };

                    schema.databaseVersions.push(versionData);
                    output.innerHTML += `<p class="success">‚úÖ ${db.name} analys√©</p>`;
                }

                // 3. T√©l√©charger le JSON
                const jsonString = JSON.stringify(schema, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'database-schema.json';
                a.click();
                URL.revokeObjectURL(url);

                output.innerHTML += '<h2 class="success">‚úÖ Sch√©ma g√©n√©r√© et t√©l√©charg√© !</h2>';
                output.innerHTML += `<p>Fichier: <strong>database-schema.json</strong> (${(jsonString.length / 1024).toFixed(2)} KB)</p>`;

            } catch (error) {
                output.innerHTML += `<p class="error">‚ùå Erreur: ${error.message}</p>`;
                console.error(error);
            }
        };

        /**
         * Analyse les camera groups pour d√©tecter les patterns
         */
        function analyzeCameraGroups(cameraGroupsDetails) {
            const groups = {
                exterior: { available: false, pattern: null, groups: [] },
                interior: { available: false, pattern: null, groups: [] },
                configuration: { available: false, pattern: null, groups: [] },
                overview: { available: false, pattern: null, groups: [] }
            };

            cameraGroupsDetails.forEach(({ name, id }) => {
                if (name.startsWith('Exterieur')) {
                    groups.exterior.available = true;
                    groups.exterior.groups.push({ name, id });
                    if (name.includes('Decor')) {
                        groups.exterior.pattern = 'Exterieur_Decor{name}';
                    } else {
                        groups.exterior.pattern = 'Exterieur';
                    }
                } else if (name.startsWith('Interieur')) {
                    groups.interior.available = true;
                    groups.interior.groups.push({ name, id });
                    groups.interior.pattern = 'Interieur';
                } else if (name === 'Configuration') {
                    groups.configuration.available = true;
                    groups.configuration.groups.push({ name, id });
                    groups.configuration.pattern = 'Configuration';
                } else if (name === 'Overview') {
                    groups.overview.available = true;
                    groups.overview.groups.push({ name, id });
                    groups.overview.pattern = 'Overview';
                }
            });

            return groups;
        }

        /**
         * Analyse les features disponibles
         */
        function analyzeFeatures(params, cameraGroups) {
            const features = {
                hasOverview: cameraGroups.overview.available,
                hasConfiguration: cameraGroups.configuration.available,
                hasPrestige: params.prestigeOptions.length > 0,
                hasStitching: params.parameters.includes('Interior_Stitching'),
                hasTablet: params.parameters.includes('Tablet'),
                hasTBM980: params.configurationBookmarks.some(b => b.includes('TBM980'))
            };

            return features;
        }

        /**
         * Construit le sch√©ma des parameters avec leurs options
         */
        function buildParametersSchema(parametersDetails) {
            const schema = {};

            parametersDetails.forEach(param => {
                schema[param.label] = {
                    xmlName: param.label,
                    options: param.options.map(opt => ({
                        label: opt.label,
                        value: opt.symbol
                    }))
                };
            });

            return schema;
        }
    </script>
</body>
</html>
